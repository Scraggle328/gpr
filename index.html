<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guided Path Forward — Chat</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7f9; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 18px; }
    .card { background: #fff; border: 1px solid #e6e8ee; border-radius: 14px; box-shadow: 0 4px 16px rgba(0,0,0,.04); overflow: hidden; }
    header { padding: 14px 16px; border-bottom: 1px solid #eef0f4; }
    header .title { font-weight: 700; font-size: 16px; }
    header .sub { color: #5b6472; font-size: 13px; margin-top: 4px; line-height: 1.35; }
    .chat { height: 420px; overflow: auto; padding: 14px 14px 6px; background: #fbfcfe; }
    .msg { display: flex; margin: 10px 0; }
    .bubble { max-width: 82%; padding: 10px 12px; border-radius: 14px; line-height: 1.35; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; }
    .user { justify-content: flex-end; }
    .user .bubble { background: #1f6feb; color: #fff; border-bottom-right-radius: 6px; }
    .bot .bubble { background: #ffffff; border: 1px solid #e6e8ee; color: #111827; border-bottom-left-radius: 6px; }
    .meta { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .footer { display: flex; gap: 10px; padding: 12px; border-top: 1px solid #eef0f4; background: #fff; align-items: center; }
    input[type="text"] {
      flex: 1; padding: 11px 12px; border: 1px solid #d8dde6; border-radius: 10px;
      font-size: 14px; outline: none;
    }
    input[type="text"]:focus { border-color: #1f6feb; box-shadow: 0 0 0 3px rgba(31,111,235,.12); }
    button {
      padding: 11px 14px; border: 0; border-radius: 10px; background: #111827; color: #fff; cursor: pointer;
      font-weight: 600; font-size: 14px;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .hint { padding: 10px 14px 14px; color: #6b7280; font-size: 12px; line-height: 1.35; }
    .pillrow { display:flex; gap:8px; flex-wrap: wrap; margin-top: 10px; }
    .pill { border: 1px solid #d8dde6; background:#fff; border-radius: 999px; padding: 8px 10px; font-size: 13px; cursor:pointer; }
    .pill:hover { border-color:#1f6feb; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="title">Guided Path Forward</div>
        <div class="sub">
          This chat provides general program information (not legal or clinical advice). Please avoid sharing sensitive personal details.
        </div>
        <div class="pillrow" id="pills">
          <div class="pill" data-text="I’m a parent/supporter looking for help.">Parent / Supporter</div>
          <div class="pill" data-text="I’m a school or court official exploring options.">School / Court</div>
          <div class="pill" data-text="I’m a young person looking to make better choices.">Young Person</div>
        </div>
      </header>

      <div class="chat" id="chat"></div>

      <div class="hint">
        Tip: We can help.  Just ask one question at a time to learn more about our program.</b>.
      </div>

      <div class="footer">
        <input id="input" type="text" placeholder="Type your message…" autocomplete="off" />
        <button id="send">Send</button>
      </div>
    </div>
  </div>

  <script>
    // 1) IMPORTANT: Replace this with your n8n Webhook URL
    const WEBHOOK_URL = "https://gpforward.app.n8n.cloud/webhook/ccbe0640-369d-451b-b8f6-2794bea9f806";

    // 2) Session id so the agent can keep context across turns
    const SESSION_KEY = "gpf_session_id";
    const sessionId = (localStorage.getItem(SESSION_KEY) || crypto.randomUUID());
    localStorage.setItem(SESSION_KEY, sessionId);

    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const pillsEl = document.getElementById("pills");

    function addMessage(role, text) {
      const row = document.createElement("div");
      row.className = "msg " + (role === "user" ? "user" : "bot");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      row.appendChild(bubble);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function sendMessage(text) {
      if (!text.trim()) return;

      addMessage("user", text);
      inputEl.value = "";
      inputEl.focus();

      sendBtn.disabled = true;
      const thinking = "…";
      addMessage("bot", thinking);

      try {
        // This payload matches the pattern seen in your n8n logs (action + chatInput + sessionId)
        const payload = {
          action: "sendMessage",
          chatInput: text,
          sessionId: sessionId
        };

        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const contentType = res.headers.get("content-type") || "";
        let replyText = "";

        if (contentType.includes("application/json")) {
          const data = await res.json();
          // Common n8n patterns:
          // - { "text": "..." }
          // - { "output": "..." }
          // - { "data": { "text": "..." } }
          replyText =
            (data && (data.text || data.output)) ||
            (data && data.data && (data.data.text || data.data.output)) ||
            JSON.stringify(data);
        } else {
          replyText = await res.text();
        }

        // Replace the last bot "…" with the real answer
        chatEl.lastChild.querySelector(".bubble").textContent = replyText;

      } catch (err) {
        chatEl.lastChild.querySelector(".bubble").textContent =
          "Sorry — I couldn’t reach the chat service. Please try again in a moment.";
        console.error(err);
      } finally {
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", () => sendMessage(inputEl.value));
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage(inputEl.value);
    });

    pillsEl.addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if (!pill) return;
      sendMessage(pill.dataset.text);
    });

  
  </script>
</body>
</html>
